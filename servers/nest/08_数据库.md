# 操作数据库

## node 连接数据库的两种方式

`mysql2` 和 `typeorm` 两种方式来操作数据库。

mysql2 是 mysql 的升级版，有更多的特性。

安装

```bash
pnpm install --save mysql2
```

mysql2 连接数据库

```js
// 连接数据库
const connection = mysql2.createConnection({
  host: "localhost",
  port: 3306,
  user: "root",
  password: "xxxx",
  database: "xxxxxxxx",
});

// 查
connection.query("SELECT * FROM degree_level", function (err, results, fields) {
  console.log(results);
  console.log(fields.map((item) => item.name));
});

// 增
connection.execute(
  "INSERT INTO degree_level (id, name) VALUES (?,?)",
  ["432sdfa", "测试"],
  (err, results, fields) => {
    console.log(err, results, fields);
  }
);

// 改
connection.execute(
  "UPDATE degree_level set name='新测试' where name='测试'",
  (err, results, fields) => {
    console.log(err, results, fields);
  }
);

// 删
connection.execute(
  "DELETE FROM degree_level WHERE name=?",
  ["新测试"],
  (err, results, fields) => {
    console.log(err, results, fields);
  }
);
```

都是支持回调函数的形式，当然也支持 Promise 的形式（可以尝试一下）。回调函数形式：

- errr 错误信息
- results 结果集
- fields 字段信息（元数据）

**最基本的使用：需要操作数据库的时候，建立连接，用完之后释放连接**。但是性能不高，需要使用连接池。
连接池里面存放好几个连接对象，每次需要操作数据库的时候，从连接池里面获取一个连接对象，用完之后，归还给连接池。

```js
const pool = mysql.createPool({
  host: "localhost",
  user: "root",
  password: "xxx",
  database: "xxxxx",
  /** 如果现在没有可用连接了，那就等待，设置为 false 就是直接返回报错 */
  waitForConnections: true,
  /** 最多有多少个连接，比如说10个，如果超过10个，就需要排队等待 */
  connectionLimit: 10,
  /** 最多有多少个空闲的，超过这个数量的空闲连接会被释放 */
  maxIdle: 10,
  /** 空闲的连接多久会断开 */
  idleTimeout: 60000,
  /** 排队的请求数量，超过这个数量就直接返回报错说没有连接了。设置为 0 就是排队没有上限 */
  queueLimit: 0,
  /** 保持心跳用的, 用默认的就好 */
  enableKeepAlive: true,
  /** 保持心跳用的, 用默认的就好 */
  keepAliveInitialDelay: 0,
});
```

创建连接池之后，就可以使用连接池里面的连接对象了。

> query 和 execute 都是用来执行 SQL 语句的方法。
> 主要的差异在于：预处理语句的执行。

# 数据库连接

# SQL 语法
