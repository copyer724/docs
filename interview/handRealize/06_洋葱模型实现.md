# 洋葱模型实现

### 本质

洋葱模型的本质就是默认函数内部末尾会自动执行下一个任务，而 next 只是确定了任务执行中的哪个时期。

### 实现

```js
class Task {
  _tasks = [];
  _currentIndex = 0;

  add(task) {
    if (!task && typeof task === "function") return;
    this._tasks.push(task);
  }

  async run() {
    await this._tasks[this._currentIndex](this.next.bind(this));
    this.next();
  }

  async next() {
    this._currentIndex++;
    if (this._currentIndex >= this._tasks.length) {
      this._tasks = [];
      this._currentIndex = 0;
      return;
    }
    await this.run();
  }
}
```

### 验证

```js
const task = new Task();

task.add(async (next) => {
  console.log("start 1");
  await next();
  console.log("end 1");
});

task.add(() => {
  console.log("2");
});

task.add(async (next) => {
  console.log("start 3");
  await next();
  console.log("end 3");
});

task.run();
```

### 效果

```ts
start 1
2
start 3
end 3
end 1
```
